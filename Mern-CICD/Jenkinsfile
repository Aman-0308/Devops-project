pipeline {
    agent any  // Specifying the agent where the pipeline will run

    environment {
        Git_URL = 'https://github.com/Aman-0308/Devops-project.git'  // Storing Git url to ennviroment variable
    }

    stages {
        stage("Checkout SCM") {
            steps {
                echo "Cloning Git repo"
                checkout scm
                echo "Git clone successful"
            }
        }

        stage("Build") {
            parallel {
                stage("Build Frontend") {
                    steps {
                        echo "Building Frontend Docker Image"
                        sh """
                            cd Mern-CICD/mern/frontend
                            docker build -t mern-frontend:V1 .
                        """
                        echo "Frontend Docker build successful"
                    }
                }
                stage("Build Backend") {
                    steps {
                        echo "Building backend Docker Image"
                        sh """
                            cd Mern-CICD/mern/backend
                            docker build -t mern-backend:V1 .

                         """
                         echo "Backend Docker build successful"

                    }
                }
            }
        }

        stage("Push Images to Docker Hub") {
            steps {
                echo "Logging into Docker Hub"
                withCredentials([usernamePassword(credentialsId: 'Dockerhub', passwordVariable: 'DOCKERHUB_PASS', usernameVariable: 'DOCKERHUB_USER')]) {
                    // Use env to explicitly reference variables in shell commands
                    // Dockerhub credentials needs to be added as global variable under manage jenkins --> crendetails >> add global variable.
                    echo "Docker login to Docker Hub"
                    sh """
                        docker login -u ${env.DOCKERHUB_USER} -p ${env.DOCKERHUB_PASS}
                    """

                    echo "Pushing Frontend Docker image"
                    sh """
                        # Image has to be tag to dockerhub
                        docker tag mern-frontend:V1 ${env.DOCKERHUB_USER}/mern-frontend:V1  
                        docker tag mern-backend:V1 ${env.DOCKERHUB_USER}/mern-backend:V1 
                    """

                    echo "Pushing Backend Docker image"
                    sh """
                        # Image has to be pushed to dockerhub
                        docker push ${env.DOCKERHUB_USER}/mern-backend:V1
                        docker push ${env.DOCKERHUB_USER}/mern-frontend:V1
                    """
                }
            }
        }
        stage("Deploy") {
            steps {
                echo "Deploying"
                sh """
                    # SSH into the remote server
                    ssh -T -i /mnt/c/Users/rahul/downloads/demo1.pem ubuntu@13.60.245.165

                    # Pulling frontend and backend images from Docker Hub  
                    docker pull amanahuja03/mern-backend:V1
                    docker pull amanahuja03/mern-frontend:V1  
               
                    # Pulling frontend and backend images from Docker Hub  
                    docker run -d -p 5050:5050 amanahuja03/mern-frontend:V1
                    docker run -d -p 5173:5173 amanahuja03/mern-backend:v1

                """
                echo "deployment completed sucessfully"
                }
        }
    }
}

